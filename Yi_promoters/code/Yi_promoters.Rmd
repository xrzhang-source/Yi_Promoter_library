---
title: "Tissue-specific promoters MPRA library analysis"
Author: Xiaoran Zhang
Email: xiaoranzhang@childrens.harvard.edu
output:
  html_document:
    df_print: paged
Corresponding email: william.pu@enders.tch.harvard.edu
Corresponding author: William T. Pu
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. ##library needed packages

```{r}
library(ggplot2)
library(DESeq2)
library(Rfast)
library(dplyr)
library(reshape2)
library(fitdistrplus)
library(compositions)
library(stats)
library(scrime)
library(corrplot)
library(pheatmap)
library(fdrtool)
library(coin)
library(stringr)
library(patchwork)
```

##source MPRA_analyzer Package

```{r}
source(file = "./MPRA_analyzer_2.R") 
```

```{r}
#inputfile<-"../data/CHD_MPRA_raw_counts_DNA1-4_RNA1-4.txt"
inputfile<-"../data/AAVDNA_1-5_liverDNA_1-5_ARNA_1-6_SRNA_1-5_LRNA_1-5_VRNA_1-5_merged_counts_result_with_header.txt"
data<-read.table(file=inputfile,header=T,row.names = 1)
head(data)
# colnames(data)
 annote<-read.table(file="../data/Promoters_annotation_new.txt",row.names = 1,header = T)
# annote<- annote[annote$group != "NC_I",]
# data<-data[rownames(annote),]
# dim(data)
# dim(annote)
# write.table(data, "../data/AAVDNA_1-5_liverDNA_1-5_ARNA_1-6_SRNA_1-5_LRNA_1-5_VRNA_1-5_merged_counts_result_with_header.txt",sep="\t",quote=F)
# write.table(annote, "../data/Promoters_annotation_new.txt",sep="\t",quote=F)
```
##Creat MPRA data set
```{r}
#RNA_Liver=data[,c(22:26)]
#RNA_A=data[,c(11:16)]
#RNA_S=data[,c(17:21)]
RNA_L=data[,c(22:26)]
#RNA_V=data[,c(27,31)]
DNA=data[,c(1:5)]
DNA_L=data[,c(6:10)]
RNA=data[,c(11:31)]
#annot=data[,c(9:11)] %>% as.data.frame()
annot=as.data.frame(annote)
rownames(annot)<-rownames(DNA)
#colnames(annot)<-c("Promoters","enhancer_type","group","raw_names","A","V","S","L")
data_norm<-create_MPRA_class(RNA=RNA,DNA=DNA,annot=annot)
#data_norm_L<-create_MPRA_class(RNA=RNA_L,DNA=DNA,annot=annot)
data_norm_L2<-create_MPRA_class(RNA=RNA_L,DNA=DNA_L,annot=annot)
#data_norm_A<-create_MPRA_class(RNA=RNA_A,DNA=DNA,annot=annot)
#data_norm_S<-create_MPRA_class(RNA=RNA_S,DNA=DNA,annot=annot)
#data_norm_V<-create_MPRA_class(RNA=RNA_V,DNA=DNA,annot=annot)
```
##Plot DNA counts distribution
```{r}
filter_norm_data <- filter_data(data_norm, dna_filter=0,equal_or_not=F)
filter_norm_data_L2 <- filter_data(data_norm_L2, dna_filter=0,equal_or_not=F)
DNA_total <- as.data.frame(matrixStats::rowMins(as.matrix(filter_norm_data@DNA)))
DNA_total_L2 <- as.data.frame(matrixStats::rowMins(as.matrix(filter_norm_data_L2@DNA)))
colnames(DNA_total)<-"minDNA"
colnames(DNA_total_L2)<-"minDNA"
dim(filter_norm_data@DNA)
dim(filter_norm_data_L2@DNA)

pdf("./DNA_counts_distribution_AAV_DNA_Liver_DNApromoter.pdf")
ggplot(DNA_total, aes(x = minDNA))+ geom_histogram(binwidth = 2,color="skyblue")+theme_bw()+theme_classic()+
  geom_vline(xintercept = 6,color="skyblue",size=0.4,linetype="dashed")+xlim(0,300)
ggplot(DNA_total_L2, aes(x = minDNA))+ geom_histogram(binwidth = 2,color="skyblue")+theme_bw()+theme_classic()+
  geom_vline(xintercept = 6,color="skyblue",size=0.4,linetype="dashed")+xlim(0,300)
dev.off()
```
## DEseq2 to got active enhancers
```{r}
source(file = "./MPRA_analyzer_2.R") 

filter_norm_data <-DEGseq2_active(filter_norm_data=filter_norm_data, addname = "L_DESeq2_Active",RNA_cols = c(12:16))
filter_norm_data_L2 <-DEGseq2_active(filter_norm_data=filter_norm_data_L2, addname = "L2_DESeq2_Active")
filter_norm_data <-DEGseq2_active(filter_norm_data=filter_norm_data, addname = "A_DESeq2_Active",RNA_cols = c(1:6))
filter_norm_data <-DEGseq2_active(filter_norm_data=filter_norm_data, addname = "S_DESeq2_Active",RNA_cols = c(7:11))
filter_norm_data <-DEGseq2_active(filter_norm_data=filter_norm_data, addname = "V_DESeq2_Active",RNA_cols = c(17:21))
sum(filter_norm_data@res$A_DESeq2_Active)
sum(filter_norm_data@res$V_DESeq2_Active)
sum(filter_norm_data@res$L_DESeq2_Active)
sum(filter_norm_data@res$S_DESeq2_Active)
sum(filter_norm_data_L2@res$L2_DESeq2_Active)
results<- cbind(filter_norm_data@annot,filter_norm_data@res)
results_L2<- cbind(filter_norm_data_L2@annot,filter_norm_data_L2@res)
table(results[,c("enhancer_type","A_DESeq2_Active")])
table(results[,c("enhancer_type","L_DESeq2_Active")])
table(results_L2[,c("enhancer_type","L2_DESeq2_Active")])
table(results[,c("enhancer_type","S_DESeq2_Active")])
table(results[,c("enhancer_type","V_DESeq2_Active")])
table(results[,c("enhancer_type","A_DESeq2_Active","A")])
table(results[,c("enhancer_type","L_DESeq2_Active","L")])
table(results_L2[,c("enhancer_type","L2_DESeq2_Active","L")])
table(results[,c("enhancer_type","S_DESeq2_Active","S")])
table(results[,c("enhancer_type","V_DESeq2_Active","V")])
```
##DNA counts distribution
```{r}
#filter_norm_data_new <- filter_data(filter_norm_data, dna_filter=5,filter_by="Max")
filter_norm_data_new <- filter_data(filter_norm_data, dna_filter=10,filter_by="Min")
#filter_norm_data_new_L2 <- filter_data(filter_norm_data_L2, dna_filter=5,filter_by="Max")
filter_norm_data_new_L2 <- filter_data(filter_norm_data_L2, dna_filter=10,filter_by="Min")
total_number <- length(filter_norm_data@DNA[,1])
kept_number <- length(filter_norm_data_new@DNA[,1])
keptratio <- kept_number/total_number
DNA_counts <- data.frame(
  label=c("total_number","kept_number","keptratio"),
  value=c(as.character(total_number),as.character(kept_number),as.character(keptratio))
)
DNA_counts

total_number <- length(filter_norm_data_L2@DNA[,1])
kept_number <- length(filter_norm_data_new_L2@DNA[,1])
keptratio <- kept_number/total_number
DNA_counts <- data.frame(
  label=c("total_number","kept_number","keptratio"),
  value=c(as.character(total_number),as.character(kept_number),as.character(keptratio))
)
DNA_counts

##4210 ref-alt pair
##4974 alt 4993 ref
##136 alt coding
##140 ref coding
```
## got RNA/DNA ratio
```{r}
filter_norm_data_new <- get_ratio(data=filter_norm_data_new, DNA_merge="Median")
filter_norm_data_new_L2 <- get_ratio(data=filter_norm_data_new_L2, DNA_merge="Paired")
head(filter_norm_data_new@res)
```
##Size factor
```{r}
source("./MPRA_analyzer_2.R")
filter_norm_data_new@annot$group[filter_norm_data_new@annot$group==0]<-"NC_II"
filter_norm_data_new_L2@annot$group[filter_norm_data_new@annot$group==0]<-"NC_II"
#Negative_C <- t(dplyr::select(as.data.frame(t(filter_norm_data_new@now_value)), !contains("::")))
#Positive_C <- t(dplyr::select(as.data.frame(t(filter_norm_data_new@now_value)), !contains("::")))
#both_C <- rownames(rbind(Negative_C,Positive_C))
#both_C <- rownames(filter_norm_data_new@annot[filter_norm_data_new@annot$group=="PC",])
both_C <- rownames(filter_norm_data_new@annot[#filter_norm_data_new@annot$group=="PC" | 
                                               filter_norm_data_new@annot$group=="NC_I"|
                                                filter_norm_data_new@annot$group=="NC_III",])
filter_norm_data_nc <-MPRA_SizeFactors(filter_norm_data_new,both_C,c(1:21))
#filter_norm_data_nc_2 <- MPRA_gfpFactors(filter_norm_data_new,c(1:21),factors=c(1,2,3,4,5,
#                                                                                 6,1,2,3,4,
#                                                                                 1,2,3,1,2,3,
#                                                                                 3,4,5,3,2))
#filter_norm_data_nc_normalize_exp <- as.data.frame(filter_norm_data_nc@res[,c(6:9)])
filter_norm_data_nc_normalize_exp<-filter_norm_data_nc@now_value
#filter_norm_data_nc_normalize_exp<-filter_norm_data_new@now_value
filter_norm_data_nc_normalize_exp_L2<-filter_norm_data_new_L2@now_value
dim(filter_norm_data_nc_normalize_exp)
```
##PCC cor
```{r}
pdf("AVLS_pcc.pdf",width = 10,height = 10)
A_V_cor <- cor(filter_norm_data_nc_normalize_exp)
p<-corrplot(A_V_cor, method  = "number",order = "alphabet")
dev.off()
pdf("AVLS_pcc_scatter_plot.pdf",width = 20,height = 20)
scatter_plot_cor(filter_norm_data_nc_normalize_exp)
dev.off()
results <-cbind(filter_norm_data_new@now_value,filter_norm_data_new@annot, filter_norm_data_new@res)
colnames(filter_norm_data_nc_normalize_exp_L2)<-c("L2_1_ratio","L2_2_ratio","L2_3_ratio","L2_4_ratio","L2_5_ratio")
results_L2 <-merge(filter_norm_data_nc_normalize_exp,filter_norm_data_nc_normalize_exp_L2,all=T, by=0)
rownames(results_L2)<-results_L2$Row.names
colnames(results_L2)
results_L2<-results_L2[,c(c(13:17),c(23:27))]
colnames(results_L2)<-c("L_1","L_2","L_3","L_4","L_5","L2_1","L2_2,","L2_3","L2_4","L2_5")
results_L2[is.na(results_L2)]<-0
pdf("L_L2_pcc.pdf",width = 5,height = 5)
A_V_cor_L2 <- cor(results_L2)
p_L2<-corrplot(A_V_cor_L2, method  = "number",order = "alphabet")
dev.off()
#write.table(filter_norm_data_nc_normalize_exp,file = "A_V_L_S_AAV_DNA_log_ratio.txt",quote = F,sep = "\t")
#write.table(results,file = "AVLS_fulllist.txt",quote = F,sep = "\t")
#write.table(results_L2,file = "L_with_L2_fulllist.txt",quote = F,sep = "\t")
#ggplot(filter_norm_data_nc_normalize_exp,aes(x=RNA1_ratio_scaled,y=RNA2_ratio_scaled))+geom_point()+theme_bw()+theme_classic()+geom_abline(intercept = 0, slope = 1,color="black",size=0.5)+xlim(0,3)+ylim(0,3)

#head(filter_norm_data_nc_normalize_exp)
```
##got mean/median value
```{r}
colnames(filter_norm_data_nc_normalize_exp)
mean_log_A_ratio <- rowMeans(filter_norm_data_nc_normalize_exp[,c(1:6)])
mean_log_S_ratio <- rowMeans(filter_norm_data_nc_normalize_exp[,c(7:11)])
mean_log_L_ratio <- rowMeans(filter_norm_data_nc_normalize_exp[,c(12:16)])
mean_log_V_ratio <- rowMeans(filter_norm_data_nc_normalize_exp[,c(17:21)])
filter_norm_data_scaled <- cbind(filter_norm_data_nc_normalize_exp,mean_log_A_ratio,mean_log_S_ratio,mean_log_L_ratio,mean_log_V_ratio)

filter_norm_data_scaled<-as.data.frame(filter_norm_data_scaled)
filter_norm_data_scaled$A_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled$mean_log_A_ratio)))
filter_norm_data_scaled$S_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled$mean_log_S_ratio)))
filter_norm_data_scaled$L_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled$mean_log_L_ratio)))
filter_norm_data_scaled$V_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled$mean_log_V_ratio)))
filter_norm_data_nc@res$A_mean_log_ratio <-mean_log_A_ratio
filter_norm_data_nc@res$S_mean_log_ratio <-mean_log_S_ratio
filter_norm_data_nc@res$L_mean_log_ratio <-mean_log_L_ratio
filter_norm_data_nc@res$V_mean_log_ratio <-mean_log_V_ratio
filter_norm_data_nc@res$A_order <-filter_norm_data_scaled$A_rank_value
filter_norm_data_nc@res$S_order <-filter_norm_data_scaled$S_rank_value
filter_norm_data_nc@res$L_order <-filter_norm_data_scaled$L_rank_value
filter_norm_data_nc@res$V_order <-filter_norm_data_scaled$V_rank_value
filter_norm_data_scaled$group<-filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"group"]
filter_norm_data_scaled$group2<-paste0(filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"A"],"_",
                                       filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"V"],"_",
                                       filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"S"],"_",
                                       filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"L"])
filter_norm_data_scaled$A<-filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"A"]
filter_norm_data_scaled$S<-filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"S"]
filter_norm_data_scaled$L<-filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"L"]
filter_norm_data_scaled$V<-filter_norm_data_nc@annot[rownames(filter_norm_data_scaled),"V"]
filter_norm_data_scaled$A_DESeq2_Active<-filter_norm_data_nc@res[rownames(filter_norm_data_scaled),"A_DESeq2_Active"]
filter_norm_data_scaled$V_DESeq2_Active<-filter_norm_data_nc@res[rownames(filter_norm_data_scaled),"V_DESeq2_Active"]
filter_norm_data_scaled$L_DESeq2_Active<-filter_norm_data_nc@res[rownames(filter_norm_data_scaled),"L_DESeq2_Active"]
filter_norm_data_scaled$S_DESeq2_Active<-filter_norm_data_nc@res[rownames(filter_norm_data_scaled),"S_DESeq2_Active"]

########add a Group factor to the annotation matrix
```
## normalized by mCherry signal
```{r}
source("./MPRA_analyzer_2.R")
filter_norm_data_new_mcherry<-MPRA_gfpFactors(filter_norm_data_new,DNA_cols = c(1:5),RNA_cols = c(1:21),useraw=F,
                                              factors_DNA=c(1,1,1,1,1),factors_RNA = c(0.31526,0.31526,0.31526,0.31526,0.31526,0.31526,
  0.51636,0.51636,0.51636,0.51636,0.51636,
  0.69361,0.69361,0.69361,0.69361,0.69361,
  0.61719,0.61719,0.61719,0.61719,0.61719))
filter_norm_data_new_mcherry <- get_ratio(data=filter_norm_data_new_mcherry, DNA_merge="Median")
filter_norm_data_new_mcherry@annot$group[filter_norm_data_new_mcherry@annot$group==0]<-"NC_II"

filter_norm_data_nc_normalize_exp_m<-filter_norm_data_new_mcherry@now_value

dim(filter_norm_data_nc_normalize_exp_m)
colnames(filter_norm_data_nc_normalize_exp_m)
mean_log_A_ratio <- rowMeans(filter_norm_data_nc_normalize_exp_m[,c(1:6)])
mean_log_S_ratio <- rowMeans(filter_norm_data_nc_normalize_exp_m[,c(7:11)])
mean_log_L_ratio <- rowMeans(filter_norm_data_nc_normalize_exp_m[,c(12:16)])
mean_log_V_ratio <- rowMeans(filter_norm_data_nc_normalize_exp_m[,c(17:21)])
filter_norm_data_scaled_m <- cbind(filter_norm_data_nc_normalize_exp_m,mean_log_A_ratio,mean_log_S_ratio,mean_log_L_ratio,mean_log_V_ratio)

filter_norm_data_scaled_m<-as.data.frame(filter_norm_data_scaled_m)
filter_norm_data_scaled_m$A_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled_m$mean_log_A_ratio)))
filter_norm_data_scaled_m$S_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled_m$mean_log_S_ratio)))
filter_norm_data_scaled_m$L_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled_m$mean_log_L_ratio)))
filter_norm_data_scaled_m$V_rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled_m$mean_log_V_ratio)))
filter_norm_data_scaled_m@res$A_mean_log_ratio <-mean_log_A_ratio
filter_norm_data_scaled_m@res$S_mean_log_ratio <-mean_log_S_ratio
filter_norm_data_scaled_m@res$L_mean_log_ratio <-mean_log_L_ratio
filter_norm_data_scaled_m@res$V_mean_log_ratio <-mean_log_V_ratio
filter_norm_data_scaled_m@res$A_order <-filter_norm_data_scaled_m$A_rank_value
filter_norm_data_scaled_m@res$S_order <-filter_norm_data_scaled_m$S_rank_value
filter_norm_data_scaled_m@res$L_order <-filter_norm_data_scaled_m$L_rank_value
filter_norm_data_scaled_m@res$V_order <-filter_norm_data_scaled_m$V_rank_value
filter_norm_data_scaled_m$group<-filter_norm_data_new_mcherry@annot[rownames(filter_norm_data_scaled_m),"group"]
filter_norm_data_scaled_m$group2<-paste0(filter_norm_data_new_mcherry@annot[rownames(filter_norm_data_scaled_m),"A"],"_",
                                       filter_norm_data_new_mcherry@annot[rownames(filter_norm_data_scaled_m),"V"],"_",
                                       filter_norm_data_new_mcherry@annot[rownames(filter_norm_data_scaled_m),"S"],"_",
                                       filter_norm_data_new_mcherry@annot[rownames(filter_norm_data_scaled_m),"L"])
filter_norm_data_scaled_m$A<-filter_norm_data_nc_m@annot[rownames(filter_norm_data_scaled_m),"A"]
filter_norm_data_scaled_m$S<-filter_norm_data_nc_m@annot[rownames(filter_norm_data_scaled_m),"S"]
filter_norm_data_scaled_m$L<-filter_norm_data_nc_m@annot[rownames(filter_norm_data_scaled_m),"L"]
filter_norm_data_scaled_m$V<-filter_norm_data_nc_m@annot[rownames(filter_norm_data_scaled_m),"V"]
filter_norm_data_scaled_m$A_DESeq2_Active<-filter_norm_data_nc_m@res[rownames(filter_norm_data_scaled_m),"A_DESeq2_Active"]
filter_norm_data_scaled_m$V_DESeq2_Active<-filter_norm_data_nc_m@res[rownames(filter_norm_data_scaled_m),"V_DESeq2_Active"]
filter_norm_data_scaled_m$L_DESeq2_Active<-filter_norm_data_nc_m@res[rownames(filter_norm_data_scaled_m),"L_DESeq2_Active"]
filter_norm_data_scaled_m$S_DESeq2_Active<-filter_norm_data_nc_m@res[rownames(filter_norm_data_scaled_m),"S_DESeq2_Active"]
filter_norm_data_scaled_grouped_m <- as.data.frame(filter_norm_data_scaled_m)

# melt_A <- filter_norm_data_scaled_grouped[,c("mean_log_A_ratio", "A")]
# colnames(melt_A) <- c("value", "label")
# melt_A$type <- "A"
# melt_S <- filter_norm_data_scaled_grouped[,c("mean_log_S_ratio", "S")]
# colnames(melt_S) <- c("value", "label")
# melt_S$type <- "S"
# melt_L <- filter_norm_data_scaled_grouped[,c("mean_log_L_ratio", "L")]
# colnames(melt_L) <- c("value", "label")
# melt_L$type <- "L"
# melt_V <- filter_norm_data_scaled_grouped[,c("mean_log_V_ratio", "V")]
# colnames(melt_V) <- c("value", "label")
# melt_V$type <- "V"
melt_A <- filter_norm_data_scaled_grouped_m[,c("mean_log_A_ratio", "group")]
colnames(melt_A) <- c("value", "label")
melt_A$type <- "A"
melt_S <- filter_norm_data_scaled_grouped_m[,c("mean_log_S_ratio", "group")]
colnames(melt_S) <- c("value", "label")
melt_S$type <- "S"
melt_L <- filter_norm_data_scaled_grouped_m[,c("mean_log_L_ratio", "group")]
colnames(melt_L) <- c("value", "label")
melt_L$type <- "L"
melt_V <- filter_norm_data_scaled_grouped_m[,c("mean_log_V_ratio", "group")]
colnames(melt_V) <- c("value", "label")
melt_V$type <- "V"

rbind_melt <- rbind(melt_A, melt_S, melt_L, melt_V)
#pdf(file = "annotation_vs_activity_boxplot.pdf")
ggplot(rbind_melt, aes(x = factor(type,levels=c("A","V","S","L")), y = value, fill = as.factor(label))) + geom_boxplot()+theme_classic()
```

##Plot the enhancers activity and rank and group information.

```{r}
########Different activities
set.seed(11)
filter_norm_data_scaled_grouped <- as.data.frame(filter_norm_data_scaled)

# melt_A <- filter_norm_data_scaled_grouped[,c("mean_log_A_ratio", "A")]
# colnames(melt_A) <- c("value", "label")
# melt_A$type <- "A"
# melt_S <- filter_norm_data_scaled_grouped[,c("mean_log_S_ratio", "S")]
# colnames(melt_S) <- c("value", "label")
# melt_S$type <- "S"
# melt_L <- filter_norm_data_scaled_grouped[,c("mean_log_L_ratio", "L")]
# colnames(melt_L) <- c("value", "label")
# melt_L$type <- "L"
# melt_V <- filter_norm_data_scaled_grouped[,c("mean_log_V_ratio", "V")]
# colnames(melt_V) <- c("value", "label")
# melt_V$type <- "V"
melt_A <- filter_norm_data_scaled_grouped[,c("mean_log_A_ratio", "group")]
colnames(melt_A) <- c("value", "label")
melt_A$type <- "A"
melt_S <- filter_norm_data_scaled_grouped[,c("mean_log_S_ratio", "group")]
colnames(melt_S) <- c("value", "label")
melt_S$type <- "S"
melt_L <- filter_norm_data_scaled_grouped[,c("mean_log_L_ratio", "group")]
colnames(melt_L) <- c("value", "label")
melt_L$type <- "L"
melt_V <- filter_norm_data_scaled_grouped[,c("mean_log_V_ratio", "group")]
colnames(melt_V) <- c("value", "label")
melt_V$type <- "V"

rbind_melt <- rbind(melt_A, melt_S, melt_L, melt_V)
#pdf(file = "annotation_vs_activity_boxplot.pdf")
ggplot(rbind_melt, aes(x = factor(type,levels=c("A","V","S","L")), y = value, fill = as.factor(label))) + geom_boxplot()+theme_classic()
#dev.off()
```

##
```{r}
#FPM_result<-cbind(filter_norm_data_nc@now_value,filter_norm_data_scaled_grouped)
#FPM_result<-cbind(filter_norm_data_nc@DNA, filter_norm_data_nc@RNA,filter_norm_data_nc@now_value,filter_norm_data_scaled_grouped,
#                  filter_norm_data_nc@annot)
#FPM_result<-FPM_result[FPM_result$Coding !=TRUE,]
#write.table(FPM_result,file="CHD_FPM.txt",sep="\t",quote = F)

#ggplot(filter_norm_data_scaled_grouped, aes(x = mean_log_ratio, #color=group))+geom_density()+theme_bw()+theme_classic()
#ggplot(filter_norm_data_scaled_grouped, aes(x = mean_log_ratio))+geom_density()+theme_bw()+theme_classic()
##Negative control FDR 0.05
select_NC<-filter_norm_data_scaled_grouped[filter_norm_data_scaled_grouped$group %in% c("NC_II","NC_III"),]
FDR_0.95_A<-FDR_negative(select_NC,"mean_log_A_ratio")
FDR_0.95_S<-FDR_negative(select_NC,"mean_log_S_ratio")
FDR_0.95_L<-FDR_negative(select_NC,"mean_log_L_ratio")
FDR_0.95_V<-FDR_negative(select_NC,"mean_log_V_ratio")
filter_norm_data_nc@res$FDR_active_A<-0
filter_norm_data_nc@res[filter_norm_data_nc@res$A_mean_log_ratio>FDR_0.95_A,]$FDR_active_A <- 1
filter_norm_data_nc@res$FDR_active_S<-0
filter_norm_data_nc@res[filter_norm_data_nc@res$S_mean_log_ratio>FDR_0.95_S,]$FDR_active_S <- 1
filter_norm_data_nc@res$FDR_active_L<-0
filter_norm_data_nc@res[filter_norm_data_nc@res$L_mean_log_ratio>FDR_0.95_L,]$FDR_active_L <- 1
filter_norm_data_nc@res$FDR_active_V<-0
filter_norm_data_nc@res[filter_norm_data_nc@res$V_mean_log_ratio>FDR_0.95_V,]$FDR_active_V <- 1
```
##Got FDR 0.05 value
```{r}
FDR_0.95_A
FDR_0.95_V
FDR_0.95_S
FDR_0.95_L
sum(filter_norm_data_nc@res$FDR_active_A)
sum(filter_norm_data_nc@res$FDR_active_V)
sum(filter_norm_data_nc@res$FDR_active_S)
sum(filter_norm_data_nc@res$FDR_active_L)
results<- cbind(filter_norm_data_nc@annot,filter_norm_data_nc@res)
table(results[,c("enhancer_type","FDR_active_A")])
table(results[,c("enhancer_type","FDR_active_V")])
table(results[,c("enhancer_type","FDR_active_S")])
table(results[,c("enhancer_type","FDR_active_L")])
table(results[,c("enhancer_type","FDR_active_A","A")])
table(results[,c("enhancer_type","FDR_active_V","V")])
table(results[,c("enhancer_type","FDR_active_S","S")])
table(results[,c("enhancer_type","FDR_active_L","L")])

```

##Plot A
```{r}
#group_data<-as.data.frame(filter_norm_data_nc@annot$group)
#names(group_data)<-"group"
#filter_norm_data_scaled_grouped_A <- cbind(filter_norm_data_nc@res[,c("A_mean_log_ratio","A_order","A_DESeq2_Active")],
#                                         group_data)
#filter_norm_data_scaled_grouped_A$rank_value <- rank(-as.numeric(as.character(filter_norm_data_scaled_grouped_A$A_mean_log_ratio)))
filter_norm_data_scaled_grouped_test <-Enrich_score(filter_norm_data_scaled_grouped, "group", "mean_log_A_ratio", "A_rank_value",random = 2000)

dat_text <-filter_norm_data_scaled_grouped_test$dat_text
filter_norm_data_for_plot <- filter_norm_data_scaled_grouped_test$datasets
#pdf("Enrichscore_of_CHD_library.pdf")
dat_text
A<-ggplot(filter_norm_data_scaled_grouped,aes(x=A_rank_value,y=mean_log_A_ratio,color=factor(A_DESeq2_Active)))+
  geom_point(size=2)+
  geom_hline(yintercept =FDR_0.95_A , linetype="dashed",color="blue")+
  theme_bw()+
  scale_color_manual(breaks = c("1", "0"), values=c("red", "gray"))+
  theme_classic()

B<-ggplot(filter_norm_data_scaled_grouped, aes(x = A_rank_value, y = factor(group)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()

p_E<- ggplot(filter_norm_data_for_plot, aes(A_rank_value, final_ES,color=factor(score_group)))+geom_line()+theme_bw()+theme_classic()+
  #facet_wrap(~score_group,scales = "free",nrow =8)+ 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())+
  #scale_color_manual(breaks = c("Neg","Pos",
  #                              "ALT","REF"), values=c("darkblue", "darkred","blue","red"))+
  geom_hline(yintercept = 0,color="skyblue",size=0.4,linetype="dashed")+
  geom_text(
    data    = dat_text,
    mapping = aes(x = -Inf, y = -Inf, label = label),
    hjust   = -2,
    vjust   = -0.25) 
```
## save plot and pvalue
```{r}
pdf("A_rank_plot.pdf",width = 8,height = 8)
A/p_E/B

dev.off()
write.table(dat_text,"A_final_score_pvalue.txt",sep="\t",quote = F)
dat_text
```
#### S
```{r}
filter_norm_data_scaled_grouped_test <-Enrich_score(filter_norm_data_scaled_grouped, "group", "mean_log_S_ratio", "S_rank_value",random = 2000)
dat_text <-filter_norm_data_scaled_grouped_test$dat_text
filter_norm_data_for_plot <- filter_norm_data_scaled_grouped_test$datasets
#pdf("Enrichscore_of_CHD_library.pdf")
dat_text
A<-ggplot(filter_norm_data_scaled_grouped,aes(x=S_rank_value,y=mean_log_S_ratio,color=factor(S_DESeq2_Active)))+
  geom_point(size=2)+
  geom_hline(yintercept =FDR_0.95_S , linetype="dashed",color="blue")+
  theme_bw()+
  scale_color_manual(breaks = c("1", "0"), values=c("red", "gray"))+
  theme_classic()

B<-ggplot(filter_norm_data_scaled_grouped, aes(x = S_rank_value, y = factor(group)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()

p_E<- ggplot(filter_norm_data_for_plot, aes(S_rank_value, final_ES,color=factor(score_group)))+geom_line()+theme_bw()+theme_classic()+
  #facet_wrap(~score_group,scales = "free",nrow =8)+ 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())+
  #scale_color_manual(breaks = c("Neg","Pos",
  #                              "ALT","REF"), values=c("darkblue", "darkred","blue","red"))+
  geom_hline(yintercept = 0,color="skyblue",size=0.4,linetype="dashed")+
  geom_text(
    data    = dat_text,
    mapping = aes(x = -Inf, y = -Inf, label = label),
    hjust   = -2,
    vjust   = -0.25) 

A/p_E/B
dat_text

```

## save plot and pvalue
```{r}
pdf("S_rank_plot.pdf",width = 8,height = 8)
A/p_E/B

dev.off()
write.table(dat_text,"S_final_score_pvalue.txt",sep="\t",quote = F)
dat_text
```

## L
```{r}
filter_norm_data_scaled_grouped_test <-Enrich_score(filter_norm_data_scaled_grouped, "group", "mean_log_L_ratio", "L_rank_value",random = 2000)
dat_text <-filter_norm_data_scaled_grouped_test$dat_text
filter_norm_data_for_plot <- filter_norm_data_scaled_grouped_test$datasets
#pdf("Enrichscore_of_CHD_library.pdf")
dat_text
A<-ggplot(filter_norm_data_scaled_grouped,aes(x=L_rank_value,y=mean_log_L_ratio,color=factor(L_DESeq2_Active)))+
  geom_point(size=2)+
  geom_hline(yintercept =FDR_0.95_L , linetype="dashed",color="blue")+
  theme_bw()+
  scale_color_manual(breaks = c("1", "0"), values=c("red", "gray"))+
  theme_classic()

B<-ggplot(filter_norm_data_scaled_grouped, aes(x = L_rank_value, y = factor(group)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()

p_E<- ggplot(filter_norm_data_for_plot, aes(L_rank_value, final_ES,color=factor(score_group)))+geom_line()+theme_bw()+theme_classic()+
  #facet_wrap(~score_group,scales = "free",nrow =8)+ 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())+
  #scale_color_manual(breaks = c("Neg","Pos",
  #                              "ALT","REF"), values=c("darkblue", "darkred","blue","red"))+
  geom_hline(yintercept = 0,color="skyblue",size=0.4,linetype="dashed")+
  geom_text(
    data    = dat_text,
    mapping = aes(x = -Inf, y = -Inf, label = label),
    hjust   = -2,
    vjust   = -0.25) 

A/p_E/B
dat_text
```

## save plot and pvalue
```{r}
pdf("L_rank_plot.pdf",width = 8,height = 8)
A/p_E/B

dev.off()
write.table(dat_text,"L_final_score_pvalue.txt",sep="\t",quote = F)
dat_text
```

```{r}
filter_norm_data_scaled_grouped_test <-Enrich_score(filter_norm_data_scaled_grouped, "group", "mean_log_V_ratio", "V_rank_value",random = 2000)
dat_text <-filter_norm_data_scaled_grouped_test$dat_text
filter_norm_data_for_plot <- filter_norm_data_scaled_grouped_test$datasets
#pdf("Enrichscore_of_CHD_library.pdf")
dat_text
A<-ggplot(filter_norm_data_scaled_grouped,aes(x=V_rank_value,y=mean_log_V_ratio,color=factor(V_DESeq2_Active)))+
  geom_point(size=2)+
  geom_hline(yintercept =FDR_0.95_S , linetype="dashed",color="blue")+
  theme_bw()+
  scale_color_manual(breaks = c("1", "0"), values=c("red", "gray"))+
  theme_classic()

B<-ggplot(filter_norm_data_scaled_grouped, aes(x = V_rank_value, y = factor(group)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()

p_E<- ggplot(filter_norm_data_for_plot, aes(V_rank_value, final_ES,color=factor(score_group)))+geom_line()+theme_bw()+theme_classic()+
  #facet_wrap(~score_group,scales = "free",nrow =8)+ 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())+
  #scale_color_manual(breaks = c("Neg","Pos",
  #                              "ALT","REF"), values=c("darkblue", "darkred","blue","red"))+
  geom_hline(yintercept = 0,color="skyblue",size=0.4,linetype="dashed")+
  geom_text(
    data    = dat_text,
    mapping = aes(x = -Inf, y = -Inf, label = label),
    hjust   = -2,
    vjust   = -0.25) 

A/p_E/B
dat_text
```

## save plot and pvalue
```{r}
pdf("V_rank_plot.pdf",width = 8,height = 8)
A/p_E/B

dev.off()
write.table(dat_text,"V_final_score_pvalue.txt",sep="\t",quote = F)
dat_text

```
```{r}

A_group2<-ggplot(filter_norm_data_scaled_grouped, aes(x = A_rank_value, y = factor(group2)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()
L_group2<-ggplot(filter_norm_data_scaled_grouped, aes(x = L_rank_value, y = factor(group2)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()
S_group2<-ggplot(filter_norm_data_scaled_grouped, aes(x = S_rank_value, y = factor(group2)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()
V_group2<-ggplot(filter_norm_data_scaled_grouped, aes(x = V_rank_value, y = factor(group2)))+
                                               #levels=c("Neg","Pos",
                                                                             #       "ALT","REF"))))+
  geom_bin2d(aes(alpha = ..density..), fill = "slategray",binwidth = c(5,1)) +
  scale_fill_continuous(guide = "none")+
  
  theme_bw()
pdf("ALSV_rank_plot.pdf",width = 10,height = 8)
library(ggpubr)
ggarrange(A_group2, V_group2, S_group2 ,L_group2+ rremove("x.text"), 
          labels = c("A", "V", "S","L"),
          ncol = 2, nrow = 2)

dev.off()
```




## write the table
```{r}
write.table(filter_norm_data_nc@res,file = "AVLS_filter_norm_data_nc_res.txt",sep = "\t",quote = F)
write.table(filter_norm_data_scaled_grouped,file = "AVLS_filter_norm_data_scaled_grouped.txt",sep = "\t",quote = F)
```
##This part is for differently enhancers bewteen REF and ALT
```{r}
source("./MPRA_analyzer_2.R")
#saveRDS(filter_norm_data_nc,"filter_norm_data_nc.rds")
inter_join <-split_for_pair(filter_norm_data_nc, vals = c("CCT","AAG"), condition = "enhancer_type", 
                            group_by = "Promoters",kept_annot = c("A","V","S","L","group"), kept_res = c("FDR_active_A","FDR_active_S","FDR_active_L","FDR_active_V","A_mean_log_ratio","S_mean_log_ratio","L_mean_log_ratio","V_mean_log_ratio"))
inter_join <- Diff_enhancers(inter_join,c(35:40),c(1:6),addname2 = "A_AAG_activity",addname1 = "A_CCT_activity",addpvalue = "A_pvalue",addqvalue = "A_qvalue",addfold = "A_fold")
inter_join <- Diff_enhancers(inter_join,c(41:45),c(7:11),addname2 = "S_AAG_activity",addname1 = "S_CCT_activity",addpvalue = "S_pvalue",addqvalue = "S_qvalue",addfold = "S_fold")
inter_join <- Diff_enhancers(inter_join,c(46:50),c(12:16),addname2 = "L_AAG_activity",addname1 = "L_CCT_activity",addpvalue = "L_pvalue",addqvalue = "L_qvalue",addfold = "L_fold")
inter_join <- Diff_enhancers(inter_join,c(51:55),c(17:21),addname2 = "V_AAG_activity",addname1 = "V_CCT_activity",addpvalue = "V_pvalue",addqvalue = "V_qvalue",addfold = "V_fold")
colnames(inter_join)
#inter_join$REF <- rowMeans(inter_join[,7:10])
#inter_join$ALT <- rowMeans(inter_join[,1:4])
#inter_join$fold <- inter_join$ALT-inter_join$REF
inter_join$qvalue_0_05_A <- 0
inter_join$qvalue_0_05_A[inter_join$A_qvalue < 0.05] <- 1
inter_join$fold_1_5_A <- 0
inter_join$fold_1_5_A [inter_join$A_fold <= -0.58] <- 1
inter_join$fold_1_5_A [inter_join$A_fold >= 0.58] <- 2
inter_join$active_A <- 0
inter_join[inter_join$FDR_active_A_CCT==1,]$active_A <-1
inter_join[inter_join$FDR_active_A_AAG==1,]$active_A <-1
inter_join$final_sig_A <-0
inter_join$final_sig_A[inter_join$qvalue_0_05_A >0 &  inter_join$A_fold >= 0.58 & inter_join$active_A >0] <-2
inter_join$final_sig_A[inter_join$qvalue_0_05_A >0 & inter_join$A_fold <= -0.58 & inter_join$active_A >0] <-1

inter_join$qvalue_0_05_S <- 0
inter_join$qvalue_0_05_S[inter_join$S_qvalue < 0.05] <- 1
inter_join$fold_1_5_S <- 0
inter_join$fold_1_5_S [inter_join$S_fold <= -0.58] <- 1
inter_join$fold_1_5_S [inter_join$S_fold >= 0.58] <- 2
inter_join$active_S <- 0
inter_join[inter_join$FDR_active_S_CCT==1,]$active_S <-1
inter_join[inter_join$FDR_active_S_AAG==1,]$active_S <-1
inter_join$final_sig_S <-0
inter_join$final_sig_S[inter_join$qvalue_0_05_S >0 &  inter_join$S_fold >= 0.58 & inter_join$active_S >0] <-2
inter_join$final_sig_S[inter_join$qvalue_0_05_S >0 & inter_join$S_fold <= -0.58 & inter_join$active_S >0] <-1

inter_join$qvalue_0_05_L <- 0
inter_join$qvalue_0_05_L[inter_join$L_qvalue < 0.05] <- 1
inter_join$fold_1_5_L <- 0
inter_join$fold_1_5_L [inter_join$L_fold <= -0.58] <- 1
inter_join$fold_1_5_L [inter_join$L_fold >= 0.58] <- 2
inter_join$active_L <- 0
inter_join[inter_join$FDR_active_L_CCT==1,]$active_L <-1
inter_join[inter_join$FDR_active_L_AAG==1,]$active_L <-1
inter_join$final_sig_L <-0
inter_join$final_sig_L[inter_join$qvalue_0_05_L >0 &  inter_join$L_fold >= 0.58 & inter_join$active_L >0] <-2
inter_join$final_sig_L[inter_join$qvalue_0_05_L >0 & inter_join$L_fold <= -0.58 & inter_join$active_L >0] <-1

inter_join$qvalue_0_05_V <- 0
inter_join$qvalue_0_05_V[inter_join$V_qvalue < 0.05] <- 1
inter_join$fold_1_5_V <- 0
inter_join$fold_1_5_V [inter_join$V_fold <= -0.58] <- 1
inter_join$fold_1_5_V [inter_join$V_fold >= 0.58] <- 2
inter_join$active_V <- 0
inter_join[inter_join$FDR_active_V_CCT==1,]$active_V <-1
inter_join[inter_join$FDR_active_V_AAG==1,]$active_V <-1
inter_join$final_sig_V <-0
inter_join$final_sig_V[inter_join$qvalue_0_05_V >0 &  inter_join$V_fold >= 0.58 & inter_join$active_V >0] <-2
inter_join$final_sig_V[inter_join$qvalue_0_05_V >0 & inter_join$V_fold <= -0.58 & inter_join$active_V >0] <-1

inter_join$group2<-paste0(inter_join[,"A_AAG"],"_",inter_join[,"V_AAG"],"_",inter_join[,"S_AAG"],"_",inter_join[,"L_AAG"])
head(inter_join)
fold_for_plot_A<-cbind(filter_norm_data_nc@annot[,"enhancer_type"],filter_norm_data_scaled_grouped)
colnames(fold_for_plot_A)[1]<-"enhancer_type"
#inter_join_filter <-inter_join[inter_join$Coding_ALT==FALSE,]
write.table(inter_join,file="AAG_CCT_diff_Enhancers.txt",sep="\t",quote = F)
pdf("AAG_CCT_Diff_enhancers_ASLV_mean.pdf",width = 8.5,height = 9)
A1<-ggplot(inter_join,aes(A_CCT_activity, A_AAG_activity,color=factor(final_sig_A,levels=c('0','1','2')), alpha =factor(qvalue_0_05_A,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
   geom_hline(yintercept = FDR_0.95_A,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_A,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
A2<-ggplot(inter_join,aes(y=A_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
S1<-ggplot(inter_join,aes(S_CCT_activity, S_AAG_activity,color=factor(final_sig_S,levels=c('0','1','2')), alpha =factor(qvalue_0_05_S,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_S,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_S,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
S2<-ggplot(inter_join,aes(y=S_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
L1<-ggplot(inter_join,aes(L_CCT_activity, L_AAG_activity,color=factor(final_sig_L,levels=c('0','1','2')), alpha =factor(qvalue_0_05_L,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_L,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_L,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
L2<-ggplot(inter_join,aes(y=L_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
V1<-ggplot(inter_join,aes(V_CCT_activity, V_AAG_activity,color=factor(final_sig_V,levels=c('0','1','2')), alpha =factor(qvalue_0_05_V,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_V,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_V,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
V2<-ggplot(inter_join,aes(y=V_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
A1/A2
V1/V2
S1/S2
L1/L2

dev.off()
```

plot tissue specific promoters
```{r}
source("./MPRA_analyzer_2.R")
tissue_join <-as.data.frame(filter_norm_data_nc@now_value)

tissue_join <- Diff_enhancers(tissue_join,c(7:21),c(1:6),addname2 = "A_activity",addname1 = "SLV_tissue_activity",addpvalue = "A_pvalue",addqvalue = "A_qvalue",addfold = "A_fold",paired=F)
tissue_join <- Diff_enhancers(tissue_join,c(1:6,12:21),c(7:11),addname2 = "S_activity",addname1 = "ALV_activity",addpvalue = "S_pvalue",addqvalue = "S_qvalue",addfold = "S_fold",paired=F)
tissue_join <- Diff_enhancers(tissue_join,c(1:11:17:21),c(12:16),addname2 = "L_activity",addname1 = "ASV_activity",addpvalue = "L_pvalue",addqvalue = "L_qvalue",addfold = "L_fold",paired=F)
tissue_join <- Diff_enhancers(tissue_join,c(1:16),c(17:21),addname2 = "V_activity",addname1 = "ASL_activity",addpvalue = "V_pvalue",addqvalue = "V_qvalue",addfold = "V_fold",paired=F)
colnames(tissue_join)
#tissue_join$REF <- rowMeans(tissue_join[,7:10])
#tissue_join$ALT <- rowMeans(tissue_join[,1:4])
#tissue_join$fold <- tissue_join$ALT-tissue_join$REF
tissue_join$qvalue_0_05_A <- 0
tissue_join$qvalue_0_05_A[tissue_join$A_qvalue < 0.05] <- 1
tissue_join$fold_1_5_A <- 0
tissue_join$fold_1_5_A [tissue_join$A_fold <= -0.58] <- 1
tissue_join$fold_1_5_A [tissue_join$A_fold >= 0.58] <- 2
tissue_join$active_A <- 0
tissue_join[rownames(filter_norm_data_nc@annot[filter_norm_data_nc@res$FDR_active_A==1,]),]$active_A <-1
tissue_join$final_sig_A <-0
#tissue_join$final_sig_A[tissue_join$qvalue_0_05_A >0 &  tissue_join$A_fold >= 0.58 & tissue_join$active_A >0] <-2
tissue_join$final_sig_A[tissue_join$A_qvalue <0.05 & tissue_join$A_fold >= 0.58 & tissue_join$active_A >0] <-1

tissue_join$qvalue_0_05_S <- 0
tissue_join$qvalue_0_05_S[tissue_join$S_qvalue < 0.05] <- 1
tissue_join$fold_1_5_S <- 0
tissue_join$fold_1_5_S [tissue_join$S_fold <= -0.58] <- 1
tissue_join$fold_1_5_S [tissue_join$S_fold >= 0.58] <- 2
tissue_join$active_S <- 0
tissue_join[rownames(filter_norm_data_nc@annot[filter_norm_data_nc@res$FDR_active_S==1,]),]$active_S <-1
tissue_join$final_sig_S <-0
#tissue_join$final_sig_S[tissue_join$qvalue_0_05_S >0 &  tissue_join$S_fold >= 0.58 & tissue_join$active_S >0] <-2
tissue_join$final_sig_S[tissue_join$S_qvalue <0.05  & tissue_join$S_fold >= 0.58 & tissue_join$active_S >0] <-1

tissue_join$qvalue_0_05_L <- 0
tissue_join$qvalue_0_05_L[tissue_join$L_qvalue < 0.05] <- 1
tissue_join$fold_1_5_L <- 0
tissue_join$fold_1_5_L [tissue_join$L_fold <= -0.58] <- 1
tissue_join$fold_1_5_L [tissue_join$L_fold >= 0.58] <- 2
tissue_join$active_L <- 0
tissue_join[rownames(filter_norm_data_nc@annot[filter_norm_data_nc@res$FDR_active_L==1,]),]$active_L <-1
tissue_join$final_sig_L <-0
#tissue_join$final_sig_L[tissue_join$qvalue_0_05_L >0 &  tissue_join$L_fold >= 0.58 & tissue_join$active_L >0] <-2
tissue_join$final_sig_L[tissue_join$L_qvalue <0.05 & tissue_join$L_fold >= 0.58 & tissue_join$active_L >0] <-1

tissue_join$qvalue_0_05_V <- 0
tissue_join$qvalue_0_05_V[tissue_join$V_qvalue < 0.05] <- 1
tissue_join$fold_1_5_V <- 0
tissue_join$fold_1_5_V [tissue_join$V_fold <= -0.58] <- 1
tissue_join$fold_1_5_V [tissue_join$V_fold >= 0.58] <- 2
tissue_join$active_V <- 0
tissue_join[rownames(filter_norm_data_nc@annot[filter_norm_data_nc@res$FDR_active_V==1,]),]$active_V <-1
tissue_join$final_sig_V <-0
#tissue_join$final_sig_V[tissue_join$qvalue_0_05_V >0 &  tissue_join$V_fold >= 0.58 & tissue_join$active_V >0] <-2
tissue_join$final_sig_V[tissue_join$V_qvalue <0.05 & tissue_join$V_fold >= 0.58 & tissue_join$active_V >0] <-1

tissue_join$enhancer_type<-filter_norm_data_nc@annot$enhancer_type
colnames(tissue_join)
for_plot_A<-tissue_join[tissue_join$final_sig_A==1,]
for_plot_V<-tissue_join[tissue_join$final_sig_V==1,]
for_plot_S<-tissue_join[tissue_join$final_sig_S==1,]
for_plot_L<-tissue_join[tissue_join$final_sig_L==1,]
fold_for_plot<-rbind(for_plot_A,for_plot_V,for_plot_S,for_plot_L)
fold_for_plot_2<-cbind(fold_for_plot[,c(1:5)],fold_for_plot[,c(17:21)],fold_for_plot[,c(6:16)])
pheatmap(fold_for_plot_2,cluster_rows=F,cluster_cols=F,fontsize_row=1)
fold_for_plot$order_A_specific <-rank(-as.numeric(as.character(fold_for_plot$A_fold)))
fold_for_plot$order_V_specific <-rank(-as.numeric(as.character(fold_for_plot$V_fold)))
fold_for_plot$order_S_specific <-rank(-as.numeric(as.character(fold_for_plot$S_fold)))
fold_for_plot$order_L_specific <-rank(-as.numeric(as.character(fold_for_plot$L_fold)))

for_plot_A_top10<-fold_for_plot[(fold_for_plot$final_sig_A & fold_for_plot$order_A_specific<=5)==1,c(1:21)]
for_plot_V_top10<-fold_for_plot[(fold_for_plot$final_sig_V & fold_for_plot$order_V_specific<=5)==1,c(1:21)]
for_plot_L_top10<-fold_for_plot[(fold_for_plot$final_sig_L & fold_for_plot$order_L_specific<=5)==1,c(1:21)]
for_plot_S_top10<-fold_for_plot[(fold_for_plot$final_sig_S & fold_for_plot$order_S_specific<=5)==1,c(1:21)]
fold_for_plot_top10<-rbind(for_plot_A_top10,for_plot_V_top10,for_plot_S_top10,for_plot_L_top10)
fold_for_plot_top10_2<-cbind(fold_for_plot_top10[,c(1:5)],fold_for_plot_top10[,c(17:21)],fold_for_plot_top10[,c(6:16)])
pheatmap(fold_for_plot_top10_2,cluster_rows=F,cluster_cols=F,fontsize_row=6)
#fold_for_plot_A<-cbind(filter_norm_data_nc@annot[,"enhancer_type"],filter_norm_data_scaled_grouped)
#colnames(fold_for_plot_A)[1]<-"enhancer_type"
#tissue_join_filter <-tissue_join[tissue_join$Coding_ALT==FALSE,]
write.table(tissue_join,file="tissue_specific_diff_Enhancers.txt",sep="\t",quote = F)

```

```{r}

pdf("Tissue_Diff_enhancers_ASLV_mean.pdf",width = 8.5,height = 9)
A1<-ggplot(tissue_join,aes(A_CCT_activity, A_AAG_activity,color=factor(final_sig_A,levels=c('0','1','2')), alpha =factor(qvalue_0_05_A,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
   geom_hline(yintercept = FDR_0.95_A,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_A,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
A2<-ggplot(tissue_join,aes(y=A_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
S1<-ggplot(tissue_join,aes(S_CCT_activity, S_AAG_activity,color=factor(final_sig_S,levels=c('0','1','2')), alpha =factor(qvalue_0_05_S,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_S,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_S,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
S2<-ggplot(tissue_join,aes(y=S_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
L1<-ggplot(tissue_join,aes(L_CCT_activity, L_AAG_activity,color=factor(final_sig_L,levels=c('0','1','2')), alpha =factor(qvalue_0_05_L,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_L,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_L,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
L2<-ggplot(tissue_join,aes(y=L_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
V1<-ggplot(tissue_join,aes(V_CCT_activity, V_AAG_activity,color=factor(final_sig_V,levels=c('0','1','2')), alpha =factor(qvalue_0_05_V,levels=c("0","1"))))+
  geom_point()+theme_bw()+theme_classic()+geom_abline(slope = 1,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope = 1, intercept = 0.58,color="black",size=0.2,linetype="dashed")+
  geom_abline(slope=1,intercept = -0.58,color="black",size=0.2,linetype="dashed")+
     geom_hline(yintercept = FDR_0.95_V,color="black",size=0.2,linetype="dashed")+
   geom_vline(xintercept = FDR_0.95_V,color="black",size=0.2,linetype="dashed")+
  scale_color_manual(breaks = c("0", "2", "1"), values=c("gray", "red", "blue"))+
  scale_alpha_manual(breaks = c("0", "1"), values=c(0.2, 1))+
  xlim(-7,7)+ylim(-7,7)
V2<-ggplot(tissue_join,aes(y=V_fold,x=group2,color=factor(group2)))+
  geom_boxplot()+theme_bw()+theme_classic()
A1/A2
V1/V2
S1/S2
L1/L2

dev.off()
```

```{r}
######Plot different groups enhancers activity
sub2 <-inter_join_filter[inter_join_filter$final_sig !=0,c("REF","ALT","final_sig")]   
sub2$final_sig3 <-paste0("x",sub2$final_sig)
sub2[sub2$final_sig==1,]$final_sig3 <-"LoF"
sub2[sub2$final_sig==2,]$final_sig3 <-"GoF"
melt_sub2 <-melt(sub2[,c(1:2,4)])
sub3 <- cbind(filter_norm_data_nc@annot[,"groups"],filter_norm_data_nc@res[,c("mean_log_ratio")])
colnames(sub3)<-c("group","mean_log_ratio")
sub3 <- sub3[(sub3[,"group"] %in% c("Neg")),] %>% as.data.frame() 
melt_sub2$group<-paste0(melt_sub2$final_sig3,"_",melt_sub2$variable)
sub4<-melt_sub2[,c("group","value")]
colnames(sub4)<-c("group","mean_log_ratio")
sub4_for_plot<-rbind(sub3,sub4)
Anewdata <-filter_norm_data_nc@res
#library(Rmisc)
#CI(Anewdata[Anewdata$active==1,"mean_log_ratio"],ci=0.95)
#CI(Anewdata[(Anewdata$active==1),"mean_log_ratio"],ci=0.95)
Ql<-quantile(Anewdata[(Anewdata$Active==1),"mean_log_ratio"], 0.05)
Qh<-quantile(Anewdata[(Anewdata$Active==1),"mean_log_ratio"], 0.95)
#pdf("REF_ALT_GoF_LoF_boxplot_2.pdf")
ggplot(sub4_for_plot, aes(y=factor(group,levels=rev(c("GoF_REF","GoF_ALT","LoF_REF","LoF_ALT","Neg",
                                                  "Pos"))),x=as.numeric(mean_log_ratio)))+
  geom_violin(aes(fill = group))+
  geom_boxplot(aes(fill = group),color="white",width = 0.2) + theme_bw()+
  geom_vline(xintercept = Ql, color="darkblue",size=0.2,linetype="dashed")+
  geom_vline(xintercept = Qh, color="darkblue",size=0.2,linetype="dashed")

#dev.off()  
library(ggpubr)
library(tidyverse)
library(broom)
library(AICcmodavg)  
summary(sub4_for_plot)
options(scipen = 999)
sub4_for_plot$value <- as.numeric(sub4_for_plot$mean_log_ratio)
one.way <- aov(value ~ group, data = sub4_for_plot)
tukey.one.way<-TukeyHSD(one.way)
p_values <- tukey.one.way$group[, "p adj"]
tukey.one.way
```
## session Info
```{r}
sessionInfo()
```
